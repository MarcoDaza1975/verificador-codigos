<script>
  // ðŸ‘‰ AQUI VA TU URL REAL DEL WEB APP DE GOOGLE
  const LEAD_ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxfG5U_PLChNVvWSctLHvH5wW7LcxbhThF32xUMpbOXggvMK9Eht1pLviyglW6XYyzs/exec";

  // Fecha lÃ­mite de la promociÃ³n
  const PROMO_END_DATE = new Date("2025-12-30T23:59:59-03:00");

  // Mapeo de cÃ³digos a porcentaje de descuento
  const CODIGOS_DESCUENTO = {
    // 3%
    "SKM-8Q2L9D": 3,
    "SKM-4ZP7KM": 3,
    "SKM-1V8QW3": 3,
    "SKM-9KD4LX": 3,
    "SKM-3MW7QJ": 3,
    "SKM-7PL2DX": 3,
    "SKM-2QN9FJ": 3,
    "SKM-6XQ3MD": 3,
    "SKM-4BV9QP": 3,
    "SKM-9JL3TX": 3,
    "SKM-2KV7LM": 3,
    "SKM-5QX8RD": 3,

    // 4%
    "SKM-8PM3ZQ": 4,
    "SKM-3QL7DX": 4,
    "SKM-7VN4KP": 4,
    "SKM-6BR2QM": 4,
    "SKM-1TZ9LQ": 4,
    "SKM-9QF3WM": 4,
    "SKM-2MP8FX": 4,
    "SKM-4QJ6ZN": 4,
    "SKM-8LD3KQ": 4,
    "SKM-5NW9QJ": 4,
    "SKM-7QF2LX": 4,
    "SKM-9TP4WD": 4,

    // 5%
    "SKM-3BF8KZ": 5,
    "SKM-6QZ1RM": 5,
    "SKM-2JP9DW": 5,
    "SKM-8XK4LM": 5,
    "SKM-1QM7DZ": 5,
    "SKM-7KL3QP": 5,
    "SKM-9MF2LD": 5,
    "SKM-4TP8WX": 5,
    "SKM-2BV9LQ": 5,
    "SKM-5QW1RM": 5,
    "SKM-8DJ7KM": 5,
    "SKM-3XL4DP": 5,

    // 6%
    "SKM-7QZ9MF": 6,
    "SKM-1LP8ZW": 6,
    "SKM-6RM3TX": 6,
    "SKM-2QN7KD": 6,
    "SKM-9WX4MP": 6,
    "SKM-4ZL2FQ": 6,
    "SKM-8QJ9TR": 6,
    "SKM-6DP1MX": 6,
    "SKM-3BL8QW": 6,
    "SKM-7FX4LZ": 6,
    "SKM-1QZ9KP": 6,
    "SKM-5LM3DF": 6,
    "SKM-9QW7ZT": 6,
    "SKM-2XP4JM": 6,

    // 10%
    "SKM-10XQZP": 10,
    "SKM-10LMRW": 10
  };

  const formCodigo = document.getElementById("form-codigo");
  const inputCodigo = document.getElementById("codigo");
  const statusBox = document.getElementById("status");

  const leadSection = document.getElementById("lead-form");
  const leadForm = document.getElementById("form-lead");
  const leadStatus = document.getElementById("lead-status");
  const inputNombre = document.getElementById("nombre");
  const inputTelefono = document.getElementById("telefono");

  let currentCode = null;
  let currentDiscount = null;

  function setStatus(message, type) {
    statusBox.textContent = message;
    statusBox.className = "status " + type; // ok | error | info
  }

  function setLeadStatus(message, type) {
    leadStatus.textContent = message;
    leadStatus.className = "";
    leadStatus.style.display = "block";
    if (type === "ok") {
      leadStatus.classList.add("ok");
    } else if (type === "error") {
      leadStatus.classList.add("error");
    }
  }

  // --------------------------------------------
  // PASO 1: VERIFICAR EL CÃ“DIGO DE DESCUENTO
  // --------------------------------------------
  formCodigo.addEventListener("submit", function (event) {
    event.preventDefault();

    let code = (inputCodigo.value || "").trim().toUpperCase();

    if (!code) {
      setStatus("Por favor, ingresa un cÃ³digo.", "info");
      leadSection.style.display = "none";
      return;
    }

    const formatRegex = /^SKM-[A-Z0-9]+$/;
    if (!formatRegex.test(code)) {
      setStatus("Formato invÃ¡lido. Usa el formato SKM-XXXXXX.", "error");
      leadSection.style.display = "none";
      return;
    }

    const now = new Date();
    if (now > PROMO_END_DATE) {
      setStatus("La promociÃ³n ha finalizado.", "error");
      leadSection.style.display = "none";
      return;
    }

    const descuento = CODIGOS_DESCUENTO[code];

    if (!descuento) {
      setStatus("CÃ³digo no vÃ¡lido o no registrado.", "error");
      leadSection.style.display = "none";
      return;
    }

    currentCode = code;
    currentDiscount = descuento;

    if (descuento === 10) {
      setStatus(
        "ðŸŽ‰ Â¡CÃ³digo vÃ¡lido! TenÃ©s un DESCUENTO ESPECIAL del " +
          descuento +
          "%. Ahora completÃ¡ tus datos.",
        "ok"
      );
    } else {
      setStatus(
        "âœ… CÃ³digo vÃ¡lido. TenÃ©s un " +
          descuento +
          "% de descuento. CompletÃ¡ tus datos.",
        "ok"
      );
    }

    leadSection.style.display = "block";
    leadStatus.style.display = "none";
  });

  // --------------------------------------------
  // PASO 2: ENVIAR NOMBRE + CELULAR + CÃ“DIGO
  // --------------------------------------------
  leadForm.addEventListener("submit", function (event) {
    event.preventDefault();

    const nombre = (inputNombre.value || "").trim();
    const telefono = (inputTelefono.value || "").trim();

    if (!currentCode || currentDiscount == null) {
      setLeadStatus("Primero verificÃ¡ tu cÃ³digo.", "error");
      return;
    }

    if (!nombre) {
      setLeadStatus("Por favor, ingresÃ¡ tu nombre.", "error");
      return;
    }

    if (!telefono) {
      setLeadStatus("Por favor, ingresÃ¡ tu celular.", "error");
      return;
    }

    if (!LEAD_ENDPOINT_URL) {
      setLeadStatus("Error: Endpoint no configurado.", "error");
      return;
    }

    const payload = new URLSearchParams();
    payload.append("nombre", nombre);
    payload.append("telefono", telefono);
    payload.append("codigo", currentCode);
    payload.append("descuento", String(currentDiscount));
    payload.append("timestamp", new Date().toISOString());

    fetch(LEAD_ENDPOINT_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
      },
      body: payload.toString()
    })
      .then((res) => {
        if (!res.ok) throw new Error("Error del servidor");
        return res.text();
      })
      .then(() => {
        setLeadStatus("âœ… Â¡Gracias! Tus datos fueron guardados.", "ok");
      })
      .catch((err) => {
        console.error(err);
        setLeadStatus("Error al guardar los datos.", "error");
      });
  });
</script>
